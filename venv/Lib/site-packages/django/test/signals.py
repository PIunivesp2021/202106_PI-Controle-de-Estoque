import os
import time
import warnings

from asgiref.local import Local

from django.apps import apps
from django.core.exceptions import ImproperlyConfigured
from django.core.signals import setting_changed
from django.db import connections, router
from django.db.utils import ConnectionRouter
from django.dispatch import Signal, receiver
from django.utils import timezone
from django.utils.formats import FORMAT_SETTINGS, reset_format_cache
from django.utils.functional import empty

template_rendered = Signal()

# Most setting_changed receivers are supposed to be added below,
# except for cases where the receiver is related to a contrib app.

# Settings that may not work well when using 'override_settings' (#19031)
<<<<<<< HEAD
COMPLEX_OVERRIDE_SETTINGS = {'DATABASES'}
=======
COMPLEX_OVERRIDE_SETTINGS = {"DATABASES"}
>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76


@receiver(setting_changed)
def clear_cache_handlers(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] == 'CACHES':
        from django.core.cache import caches, close_caches
=======
    if kwargs["setting"] == "CACHES":
        from django.core.cache import caches, close_caches

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        close_caches()
        caches._settings = caches.settings = caches.configure_settings(None)
        caches._connections = Local()


@receiver(setting_changed)
def update_installed_apps(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] == 'INSTALLED_APPS':
        # Rebuild any AppDirectoriesFinder instance.
        from django.contrib.staticfiles.finders import get_finder
        get_finder.cache_clear()
        # Rebuild management commands cache
        from django.core.management import get_commands
        get_commands.cache_clear()
        # Rebuild get_app_template_dirs cache.
        from django.template.utils import get_app_template_dirs
        get_app_template_dirs.cache_clear()
        # Rebuild translations cache.
        from django.utils.translation import trans_real
=======
    if kwargs["setting"] == "INSTALLED_APPS":
        # Rebuild any AppDirectoriesFinder instance.
        from django.contrib.staticfiles.finders import get_finder

        get_finder.cache_clear()
        # Rebuild management commands cache
        from django.core.management import get_commands

        get_commands.cache_clear()
        # Rebuild get_app_template_dirs cache.
        from django.template.utils import get_app_template_dirs

        get_app_template_dirs.cache_clear()
        # Rebuild translations cache.
        from django.utils.translation import trans_real

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        trans_real._translations = {}


@receiver(setting_changed)
def update_connections_time_zone(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] == 'TIME_ZONE':
        # Reset process time zone
        if hasattr(time, 'tzset'):
            if kwargs['value']:
                os.environ['TZ'] = kwargs['value']
            else:
                os.environ.pop('TZ', None)
=======
    if kwargs["setting"] == "TIME_ZONE":
        # Reset process time zone
        if hasattr(time, "tzset"):
            if kwargs["value"]:
                os.environ["TZ"] = kwargs["value"]
            else:
                os.environ.pop("TZ", None)
>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
            time.tzset()

        # Reset local time zone cache
        timezone.get_default_timezone.cache_clear()

    # Reset the database connections' time zone
<<<<<<< HEAD
    if kwargs['setting'] in {'TIME_ZONE', 'USE_TZ'}:
=======
    if kwargs["setting"] in {"TIME_ZONE", "USE_TZ"}:
>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        for conn in connections.all():
            try:
                del conn.timezone
            except AttributeError:
                pass
            try:
                del conn.timezone_name
            except AttributeError:
                pass
            conn.ensure_timezone()


@receiver(setting_changed)
def clear_routers_cache(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] == 'DATABASE_ROUTERS':
=======
    if kwargs["setting"] == "DATABASE_ROUTERS":
>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        router.routers = ConnectionRouter().routers


@receiver(setting_changed)
def reset_template_engines(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] in {
        'TEMPLATES',
        'DEBUG',
        'INSTALLED_APPS',
    }:
        from django.template import engines
=======
    if kwargs["setting"] in {
        "TEMPLATES",
        "DEBUG",
        "INSTALLED_APPS",
    }:
        from django.template import engines

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        try:
            del engines.templates
        except AttributeError:
            pass
        engines._templates = None
        engines._engines = {}
        from django.template.engine import Engine
<<<<<<< HEAD
        Engine.get_default.cache_clear()
        from django.forms.renderers import get_default_renderer
=======

        Engine.get_default.cache_clear()
        from django.forms.renderers import get_default_renderer

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        get_default_renderer.cache_clear()


@receiver(setting_changed)
def clear_serializers_cache(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] == 'SERIALIZATION_MODULES':
        from django.core import serializers
=======
    if kwargs["setting"] == "SERIALIZATION_MODULES":
        from django.core import serializers

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        serializers._serializers = {}


@receiver(setting_changed)
def language_changed(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] in {'LANGUAGES', 'LANGUAGE_CODE', 'LOCALE_PATHS'}:
        from django.utils.translation import trans_real
        trans_real._default = None
        trans_real._active = Local()
    if kwargs['setting'] in {'LANGUAGES', 'LOCALE_PATHS'}:
        from django.utils.translation import trans_real
=======
    if kwargs["setting"] in {"LANGUAGES", "LANGUAGE_CODE", "LOCALE_PATHS"}:
        from django.utils.translation import trans_real

        trans_real._default = None
        trans_real._active = Local()
    if kwargs["setting"] in {"LANGUAGES", "LOCALE_PATHS"}:
        from django.utils.translation import trans_real

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        trans_real._translations = {}
        trans_real.check_for_language.cache_clear()


@receiver(setting_changed)
def localize_settings_changed(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] in FORMAT_SETTINGS or kwargs['setting'] == 'USE_THOUSAND_SEPARATOR':
=======
    if (
        kwargs["setting"] in FORMAT_SETTINGS
        or kwargs["setting"] == "USE_THOUSAND_SEPARATOR"
    ):
>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        reset_format_cache()


@receiver(setting_changed)
def file_storage_changed(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] == 'DEFAULT_FILE_STORAGE':
        from django.core.files.storage import default_storage
=======
    if kwargs["setting"] == "DEFAULT_FILE_STORAGE":
        from django.core.files.storage import default_storage

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        default_storage._wrapped = empty


@receiver(setting_changed)
def complex_setting_changed(**kwargs):
<<<<<<< HEAD
    if kwargs['enter'] and kwargs['setting'] in COMPLEX_OVERRIDE_SETTINGS:
        # Considering the current implementation of the signals framework,
        # this stacklevel shows the line containing the override_settings call.
        warnings.warn("Overriding setting %s can lead to unexpected behavior."
                      % kwargs['setting'], stacklevel=6)
=======
    if kwargs["enter"] and kwargs["setting"] in COMPLEX_OVERRIDE_SETTINGS:
        # Considering the current implementation of the signals framework,
        # this stacklevel shows the line containing the override_settings call.
        warnings.warn(
            "Overriding setting %s can lead to unexpected behavior."
            % kwargs["setting"],
            stacklevel=6,
        )
>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76


@receiver(setting_changed)
def root_urlconf_changed(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] == 'ROOT_URLCONF':
        from django.urls import clear_url_caches, set_urlconf
=======
    if kwargs["setting"] == "ROOT_URLCONF":
        from django.urls import clear_url_caches, set_urlconf

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        clear_url_caches()
        set_urlconf(None)


@receiver(setting_changed)
def static_storage_changed(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] in {
        'STATICFILES_STORAGE',
        'STATIC_ROOT',
        'STATIC_URL',
    }:
        from django.contrib.staticfiles.storage import staticfiles_storage
=======
    if kwargs["setting"] in {
        "STATICFILES_STORAGE",
        "STATIC_ROOT",
        "STATIC_URL",
    }:
        from django.contrib.staticfiles.storage import staticfiles_storage

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        staticfiles_storage._wrapped = empty


@receiver(setting_changed)
def static_finders_changed(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] in {
        'STATICFILES_DIRS',
        'STATIC_ROOT',
    }:
        from django.contrib.staticfiles.finders import get_finder
=======
    if kwargs["setting"] in {
        "STATICFILES_DIRS",
        "STATIC_ROOT",
    }:
        from django.contrib.staticfiles.finders import get_finder

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        get_finder.cache_clear()


@receiver(setting_changed)
def auth_password_validators_changed(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] == 'AUTH_PASSWORD_VALIDATORS':
        from django.contrib.auth.password_validation import (
            get_default_password_validators,
        )
=======
    if kwargs["setting"] == "AUTH_PASSWORD_VALIDATORS":
        from django.contrib.auth.password_validation import (
            get_default_password_validators,
        )

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
        get_default_password_validators.cache_clear()


@receiver(setting_changed)
def user_model_swapped(**kwargs):
<<<<<<< HEAD
    if kwargs['setting'] == 'AUTH_USER_MODEL':
        apps.clear_cache()
        try:
            from django.contrib.auth import get_user_model
=======
    if kwargs["setting"] == "AUTH_USER_MODEL":
        apps.clear_cache()
        try:
            from django.contrib.auth import get_user_model

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
            UserModel = get_user_model()
        except ImproperlyConfigured:
            # Some tests set an invalid AUTH_USER_MODEL.
            pass
        else:
            from django.contrib.auth import backends
<<<<<<< HEAD
            backends.UserModel = UserModel

            from django.contrib.auth import forms
            forms.UserModel = UserModel

            from django.contrib.auth.handlers import modwsgi
            modwsgi.UserModel = UserModel

            from django.contrib.auth.management.commands import changepassword
            changepassword.UserModel = UserModel

            from django.contrib.auth import views
=======

            backends.UserModel = UserModel

            from django.contrib.auth import forms

            forms.UserModel = UserModel

            from django.contrib.auth.handlers import modwsgi

            modwsgi.UserModel = UserModel

            from django.contrib.auth.management.commands import changepassword

            changepassword.UserModel = UserModel

            from django.contrib.auth import views

>>>>>>> 7d5f087c4e99aa85f4ff913899c3075425769d76
            views.UserModel = UserModel
